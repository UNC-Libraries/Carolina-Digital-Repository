#!/bin/sh
# This script takes a single image file as input and returns the unique iRODS path to a JP2 file to stdout.  If it fails then it will return an error code to stdout.
STAGING_PATH=/$spClientRodsZone/home/$spClientUser/staging
tmpFile=`mktemp -q`
convert -limit memory 64 -limit map 128 -define jp2:tilewidth=256 -define jp2:tileheight=256 -quality 100 ${1} JP2:$tmpFile
if [ "$?" -ne "0" ]; then
  echo "ERROR: There was a problem converting the image."
  exit 1
fi
iput $tmpFile "$STAGING_PATH/`basename $tmpFile`"
if [ "$?" -ne "0" ]; then
  echo "ERROR: There was a problem putting image into iRODS staging."
  rm $tmpFile
  exit 2
fi
rm $tmpFile
echo "$STAGING_PATH/`basename $tmpFile`"

